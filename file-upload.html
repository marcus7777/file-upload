<link rel="import" href="../polymer/polymer.html">
<script src="../js-spark-md5/spark-md5.min.js" type="text/javascript"></script>

<!--
  `<file-upload></file-upload>` upload files to firebase
  @demo demo.html
-->
<dom-module id="file-upload">
  <template>
    <input type="file" id="files" name="files[]" multiple />
  </template>
</dom-module>
<script>
  Polymer({
    is: "file-upload",
    properties:{
      url:{
        type:String,
        notify:true,
      },
    },
    ready: function(){
      var that = this
      function handleFileSelect(evt) {
        var files = evt.target.files
        Array.prototype.forEach.call(files, function(fileN) {
          var fileReader = new FileReader()
          var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice
          var chunkSize = 2097152
          var chunks = Math.ceil(fileN.size / chunkSize)
          var currentChunk = 0
          var spark = new SparkMD5.ArrayBuffer()
          var uid = that.uid || "anyone"
          
          function loadNext() {
            var start = currentChunk * chunkSize
            var end = start + chunkSize >= fileN.size ? fileN.size : start + chunkSize
            fileReader.readAsArrayBuffer(blobSlice.call(fileN, start, end))
          }
          
          function upload(hash) {
            var toUploadto = firebase.storage().ref().child(hash + "/" + uid + "/" + fileN.name)
            toUploadto.getDownloadURL().then( function (url) {
              that.set("url", url) //uploaded
            }).catch(function () {
              toUploadto.put(fileN).then(function(snapshot) { //upload
                that.set("url", snapshot.downloadURL) //uploaded
                console.log('Uploaded a blob or file!', snapshot)
              }).catch(function(e) {
                if (e.code == "storage/unauthorized") {
                  alert("unauthorized upload")
                }
                console.log(e)
              })
            })
          }
          
          fileReader.onload = function (e) {
            spark.append(e.target.result)
            currentChunk += 1
            if (currentChunk < chunks) {
              loadNext()
            } else {
              upload(spark.end())
            }
          }
          
          if (that.noMD5) {
            upload("")
          } else {
            loadNext()
          }
        })
      }
      this.$$("#files").addEventListener('change', handleFileSelect, false)
    },
  })
</script>
