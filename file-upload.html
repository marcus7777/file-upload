<link rel="import" href="../polymer/polymer.html">
<script src="../js-spark-md5/spark-md5.min.js" type="text/javascript"></script>

<!--
  `<file-upload></file-upload>` upload files to firebase
  @demo demo.html
-->
<dom-module id="file-upload">
  <template>
    <input type="file" id="files" name="files[]" multiple />
  </template>
</dom-module>
<script>
  Polymer({
    is: "file-upload",
    properties:{
      files:{
        type: Array,
        notify:true,
        value: [],
      },
      logUpload: {
        value: true,
      }
    },
    ready: function(){
      var that = this
      var uid = that.uid || firebase.auth().currentUser.uid || "anyone"
      var db = firebase.firestore()
      
      function handleFileSelect(evt) {
        Array.prototype.forEach.call(evt.target.files, function(fileN) {
          var fileReader = new FileReader()
          var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice
          var chunkSize = 2097152
          var chunks = Math.ceil(fileN.size / chunkSize)
          var currentChunk = 0
          var spark = new SparkMD5.ArrayBuffer()
          
          function loadNext() {
            var start = currentChunk * chunkSize
            var end = start + chunkSize >= fileN.size ? fileN.size : start + chunkSize
            fileReader.readAsArrayBuffer(blobSlice.call(fileN, start, end))
          }
          
          function upload(hash) {
            var toUploadto = firebase.storage().ref().child(uid + "/" + hash + "/" + fileN.name)
            
            toUploadto.getDownloadURL().then( function (url) {
              that.push("files", {name: fileN.name, url: url}) //uploaded show
            }).catch(function () {
              var meta = {}
              meta[uid] = "rw"
              console.log(meta)
              toUploadto.put(fileN, meta).then(function(snapshot) { //upload
                that.push("files", {name: fileN.name, url: snapshot.downloadURL}) //uploaded show
                toUploadto.getMetadata().then( function(x){console.log(x)} ).catch( function(e){console.log(e)} )
                if (db && that.logUpload && hash) {
                  db.collection("files").doc(hash).set({
                    uid: uid,
                    path: uid + "/" + hash + "/" + fileN.name
                  })
                }
                console.log('Uploaded a blob or file!', snapshot)
              }).catch(function(e) {
                if (e.code == "storage/unauthorized") {
                  alert("unauthorized upload")
                }
                console.log(e)
              })
            })
          }
          
          fileReader.onload = function (e) {
            spark.append(e.target.result)
            currentChunk += 1
            if (currentChunk < chunks) {
              loadNext()
            } else {
              upload(spark.end())
            }
          }
          
          if (that.noMD5) {
            upload("")
          } else {
            loadNext()
          }
        })
        evt.target.removeAttribute('value')
        evt.target.value = ""
      }
      this.$$("#files").addEventListener('change', handleFileSelect, false)
    },
  })
</script>
