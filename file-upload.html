<link rel="import" href="../polymer/polymer.html">
<script src="../js-spark-md5/spark-md5.min.js" type="text/javascript"></script>

<!--
  `<file-upload></file-upload>` upload files to firebase
  @demo demo.html
-->
<dom-module id="file-upload">
  <template>
    <input type="file" id="files" accept="[[accept]]" name="files[]" multiple />
    <template is="dom-if" if="[[uploading]]">
      ... [[uploading]]
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "file-upload",
    properties:{
      files:{
        type: Array,
        notify:true,
        value: [],
      },
      logUpload: {
        value: true,
      },
      meta: {
        value: {},
        type: Object,
      },
      uploading: {
        value: 0
      },
      accept: {
        value: "*"
      },
      _addMeta:{
        computed: "addMeta(files)", 
      },
    },
    addMeta: function(files) {
      var added = false
      var that = this
      files.forEach(function(file,index){
        if (file.ref && !file.name) {
          added = true
          file.name = file.ref.split("/").slice(-1)[0]
          firebase.storage().ref().child(file.ref).getDownloadURL().then( function (url) {
            file.url = url
            firebase.storage().ref().child(file.ref).getMetadata().then(function (metadata) {
              if (metadata.contentType.indexOf("image") !== -1) {
                file.image = url
              }
              that.set(["files",index],file)
            })
          })
        }
      })
      if (added) {
        this.timeout = setTimeout(function(){ 
          that.set("files",files.map(function (file) {
            return file
          }))
        }, 1000)
      }
    },
    ready: function(){
      var that = this
      function handleFileSelect(evt) {
        var uid = that.uid || firebase.auth().currentUser.uid || "anyone"
        var db = db || firebase.firestore()
        Array.prototype.forEach.call(evt.target.files, function(fileN) {
          var fileReader = new FileReader()
          var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice
          var chunkSize = 2097152
          var chunks = Math.ceil(fileN.size / chunkSize)
          var currentChunk = 0
          var spark = new SparkMD5.ArrayBuffer()
          
          function loadNext() {
            var start = currentChunk * chunkSize
            var end = start + chunkSize >= fileN.size ? fileN.size : start + chunkSize
            fileReader.readAsArrayBuffer(blobSlice.call(fileN, start, end))
          }
          
          function upload(hash) {
            var toUploadto = firebase.storage().ref().child(uid + "/" + hash + "/" + fileN.name)
            
            toUploadto.getDownloadURL().then( function (url) {
              firebase.storage().ref().getMetadata(uid + "/" + hash + "/" + fileN.name).then(function(metadata) {
                 

            //  var add  = {name: fileN.name, url: url.downloadURL, type: url.metadata.contentType}
            //  if (url.metadata.contentType.indexOf("image") !== -1) {
            //    add.image = url.downloadURL
            //  }
                
                var add  = {name: fileN.name, url: url, type: metadata.contentType}
                if (metadata.contentType.indexOf("image") !== -1) {
                  add.image = url
                }
                var dedup = {} 
                that.files.concat([add]).forEach(function (file) { 
                  dedup[file.name] = file
                })
                that.set("files",Object.keys(dedup).map(function (name) { 
                  return dedup[name]
                }))
                var meta = Object.assign({}, that.meta)
                meta[uid] = "userId"
                if (db && that.logUpload && hash) {
                  meta.path = uid + "/" + hash + "/" + fileN.name
                  meta.type = metadata.contentType
                  db.collection("files").doc(hash).set(meta, {merge: true})
                }
              })
            }).catch(function () {
              that.set("uploading", that.uploading + 1)
              var meta = Object.assign({}, that.meta)
              meta[uid] = "userId"
              toUploadto.put(fileN, {customMetadata:meta}).then(function(snapshot) { //upload
                var add  = {name: fileN.name, url: snapshot.downloadURL, type: snapshot.metadata.contentType}
                if (snapshot.metadata.contentType.indexOf("image") !== -1) {
                  add.image = snapshot.downloadURL
                }
                var dedup = {} 
                that.files.concat([add]).forEach(function (file) { 
                  dedup[file.name] = file
                })
                that.set("files",Object.keys(dedup).map(function (name) { 
                  return dedup[name]
                }))

                toUploadto.getMetadata().then( function(x){console.log(x)} ).catch( function(e){console.log(e)} )
                if (db && that.logUpload && hash) {
                  meta.path = uid + "/" + hash + "/" + fileN.name
                  meta.type = snapshot.metadata.contentType
                  db.collection("files").doc(hash).set(meta, {merge: true})
                }
                that.set("uploading", that.uploading - 1)
              }).catch(function(e) {
                console.log(e)
                that.set("uploading", that.uploading - 1)
              })
            })
          }
          
          fileReader.onload = function (e) {
            spark.append(e.target.result)
            currentChunk += 1
            if (currentChunk < chunks) {
              loadNext()
            } else {
              upload(spark.end())
            }
          }
          
          if (that.noMD5) {
            upload("")
          } else {
            loadNext()
          }
        })
        evt.target.removeAttribute('value')
        evt.target.value = ""
      }
      this.$$("#files").addEventListener('change', handleFileSelect, false)
    },
  })
</script>
