<link rel="import" href="../polymer/polymer.html">
<script src="../js-spark-md5/spark-md5.min.js" type="text/javascript"></script>

<!--
  `<file-upload></file-upload>` upload files to firebase
  @demo demo.html
-->
<dom-module id="file-upload">
  <template>
    <style>
      :host {display:inline-block}
    </style>
    <input type="file" id="files" name="files[]" multiple />
  </template>
</dom-module>
<script>
  Polymer({
    is: "file-upload",
    properties:{
      url:{
        type:String,
        notify:true,
      },
      
    },
    ready: function(){
      var that = this
      function handleFileSelect(evt) {
        var files = evt.target.files
        for (var i = 0, file; file = files[i]; i++) {
          var fileReader = new FileReader()
          var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice
          var chunkSize = 2097152
          var chunks = Math.ceil(file.size / chunkSize)
          var currentChunk = 0
          var spark = new SparkMD5.ArrayBuffer()
          var uid = that.uid || "anyone"
          var theFile = file
          
          function loadNext() {
            var start = currentChunk * chunkSize
            var end = start + chunkSize >= file.size ? file.size : start + chunkSize
            fileReader.readAsArrayBuffer(blobSlice.call(file, start, end))
          }
          
          function upload() {
            var toUploadto = firebase.storage().ref().child(spark.end() + "/" + uid + "/" + theFile.name)
            if (toUploadto.getDownloadURL()) {
              that.set("url", toUploadto.downloadURL) //uploaded
            } else {
              toUploadto.put(theFile).then(function(snapshot) { //upload
                that.set("url", snapshot.downloadURL) //uploaded
                console.log('Uploaded a blob or file!', snapshot)
              }).catch(function(e) {
                if (e.code == "storage/unauthorized") {
                  alert("unauthorized upload")
                }
                console.log(e)
              })
            }
          }
          
          fileReader.onload = function (e) {
            spark.append(e.target.result)
            currentChunk += 1
            if (currentChunk < chunks) {
              loadNext()
            } else {
              upload()
            }
          }
          
          if (that.noMD5) {
            upload()
          } else {
            loadNext()
          }
        }
      }
      this.$$("#files").addEventListener('change', handleFileSelect, false)
    },
  })
</script>
